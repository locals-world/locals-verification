
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../locals-input/locals-input.html">
<link rel="import" href="../locals-button/locals-button.html">
<link rel="import" href="../locals-progress/locals-progress.html">
<link rel="import" href="../locals-style/locals-style.html">
<link rel="import" href="../locals-confirm/locals-confirm.html">
<link rel="import" href="../../bower_components/iron-localstorage/iron-localstorage.html">
<script type="text/javascript" src="bower_components/jsencrypt/bin/jsencrypt.js"></script>
<script type="text/javascript" src="bower_components/cryptojslib/rollups/aes.js"></script>

<!--
Verification component listens to verification 

Example:

    <locals-verification-validator"></locals-verification-validator>

-->
<dom-module id="locals-verification-validator">

  <template>
    <style>
      :host {
        display: block;
        box-sizing: border-box;
      }
      .valbtn {
        margin-right: 10px; 
      }

      h1 {
        @apply(--locals-font-h1);
        text-align: center;
      }

      p {
        @apply(--locals-font-body1);
      }

      .total {
        width: 100vw;
        height: 100vh;
        @apply(--layout-vertical);
        background-color: var(--locals-grey1);
      }

      .topbar {
        width: 100%;
        background-color: transparent;
        height: var(--topbar-height);
        @apply(--layout-horizontal);
        @apply(--layout-center);
        box-sizing: border-box;
        padding: 10px 20px 10px 10px;
        }

      .flex {
        @apply(--layout-horizontal);
        @apply(--layout-flex);
      }

      .main {
        width: 100%;
        box-sizing: border-box;
        padding: 0px 50px 0px 50px;
        @apply(--layout-horizontal);
        @apply(--layout-start);
        @apply(--layout-center-justified);        
      }
      .addbtn {
        margin: 15px;
      }
      .homebtn {
        transition: all 5s linear;
      }
      .exit {
        -ms-transform: rotate(45deg); /* IE 9 */
        -webkit-transform: rotate(45deg); /* Chrome, Safari, Opera */
        transform: rotate(45deg);
      }

    </style>

    <iron-localstorage 
      name="locals-validations" 
      value="{{validations}}"></iron-localstorage>

    <template is="dom-if" if="{{_is(visualmode,'button')}}">
    <locals-button class="valbtn" icon="addval" small></locals-button>
    
    
    </template>

    <template is="dom-if" if="{{_is(visualmode,'list')}}">
    <div class="total">
        <div class="topbar">
          <p class="flex"></p>
          <locals-button class="exit homebtn" id="exitbtn" icon="plus" on-tap="toHome"></locals-button>
        </div>

        <h1>Jouw code is <span>{{topic}}</span> <locals-progress round value="{{progress}}" max="100" size="20"></locals-progress></h1>
      <template is="dom-if" if="{{!validations}}">
        <p>je hebt nog geen validaties</p>
      </template>
      <iron-selector attr-for-selected="key" selected="{{selected}}" on-iron-select="goDetail">
        <template is="dom-repeat" items="{{object2array(validations,validations.*)}}">
          <div key="{{item._key}}">Validation {{item._key}} {{item.avatardata.firstname}}</div>
        </template>
      </iron-selector>
    </div>
    </template>

    <template is="dom-if" if="{{_is(visualmode,'detail')}}">
      <div class="total">
        <h1><span>{{selected}}</span> bevestig?</h1>
         <locals-confirm on-confirm="addValidation" on-cancel="backList">Valideren?</locals-confirm>
         <span>{{transactionHash}}</span>
      </div>
    </template>

  </template>

</dom-module>

<script>
  Polymer({

    is: 'locals-verification-validator',

    properties: {
      sizeview: {
        type: String,
        observer: '_sizeview'
      },
      mode: {
        type: String,
      },
      topic: {
        type: String
      },
      progress: {
        type: Number
      },
      contractaddr: {
        type: String,
        value: '0xdd9894fAc561dd07A2765B3985f7E4BfAe1dB636'
      },
      contractabi: {
        type: Object,
        value: '[ { "constant": false, "inputs": [], "name": "kill", "outputs": [], "type": "function" }, { "constant": false, "inputs": [ { "name": "_localsuser", "type": "address" }, { "name": "_hash", "type": "string" } ], "name": "addVerification", "outputs": [], "type": "function" }, { "constant": true, "inputs": [], "name": "owner", "outputs": [ { "name": "", "type": "address", "value": "0x7cbfd3ca2f652e8d033ad2374090c09cd24a85d0" } ], "type": "function" }, { "constant": true, "inputs": [ { "name": "", "type": "address" } ], "name": "users", "outputs": [ { "name": "username", "type": "string", "value": "" }, { "name": "ipfshash", "type": "string", "value": "" }, { "name": "numVerifications", "type": "uint256", "value": "0" } ], "type": "function" }, { "constant": true, "inputs": [], "name": "tokenaddr", "outputs": [ { "name": "", "type": "address", "value": "0xa69153562474b1dff2ab79b7fdb75d55f659ea56" } ], "type": "function" }, { "constant": true, "inputs": [], "name": "verificationthresh", "outputs": [ { "name": "", "type": "uint256", "value": "2" } ], "type": "function" }, { "constant": true, "inputs": [], "name": "token", "outputs": [ { "name": "", "type": "address", "value": "0x0000000000000000000000000000000000000000" } ], "type": "function" }, { "inputs": [ { "name": "_verificationthresh", "type": "uint256", "index": 0, "typeShort": "uint", "bits": "256", "displayName": "&thinsp;<span class=\"punctuation\">_</span>&thinsp;verificationthresh", "template": "elements_input_uint", "value": "2" }, { "name": "token", "type": "address", "index": 1, "typeShort": "address", "bits": "", "displayName": "token", "template": "elements_input_address", "value": "0xa69153562474B1dFf2ab79b7fdB75d55f659Ea56" } ], "type": "constructor" }, { "anonymous": false, "inputs": [ { "indexed": false, "name": "_from", "type": "address" }, { "indexed": false, "name": "_to", "type": "address" }, { "indexed": false, "name": "_numverifications", "type": "uint256" } ], "name": "ValidationAdded", "type": "event" }, { "anonymous": false, "inputs": [ { "indexed": false, "name": "_from", "type": "address" }, { "indexed": false, "name": "_username", "type": "string" }, { "indexed": false, "name": "_ipfshash", "type": "string" }, { "indexed": false, "name": "_numverifications", "type": "uint256" } ], "name": "UserAdded", "type": "event" } ]'
      }
    },

    // Element Lifecycle

    ready: function() {

      //this.utilz = this.$.util;

      //debugger;
      //this.$.util.object2array({a:1});
    },

    attached: function() {
      //debugger;
      this.visualmode = 'detail';

      //this.visualmode = this.mode || 'list';     
      console.log('locals-verification-validator topic is',this.topic);

    },

    detached: function() {

    },

    toHome:function(){
      this.fire('to-home');
    },

    goDetail: function(){
      this.visualmode = 'detail';
    },

    backList: function(){
      this.visualmode = 'list';
    },

    addValidation: function(){
      var self = this;
      console.log('laat ons da eens naar een smart contract sturen');
      console.log('ik heb de user zijn account: ',this.fixaddress(this.account));

      this.contracturl = this.resolveUrl('../../contracts/localsAvatar.json');
      this.importHref(this.contracturl, function(e) {
        this.progress = 'addingtoindex';
        self.contractjson = JSON.parse(e.target.import.body.innerText);
      this.web3.eth.getGasPrice(function(err, result) {
          var gasPrice = result.toNumber(10);
          console.log('gasprice: ', gasPrice);  
          var MyContract = self.web3.eth.contract(self.contractjson.abi);
          var myContractInstance = MyContract.at(self.contractaddr);

          var otheruser = '0xfd5A58b4a5490A1A5928d08c4B9738877B97fFE9';// 'daisy'
          var hash = 'sha3hash';

          result = myContractInstance.addVerification.sendTransaction(otheruser, hash, {
              from: self.fixaddress(self.account),
              gasPrice: gasPrice,
              gasLimit: 3000000,
              gas: 2000000,
              data: self.contractjson.bytecode
            },
            function(err, result) {
              if (err !== null) {
                console.log(err);
                console.log('ERROR: Transaction didnt go through. See console.');
              } else {
                console.log('Transaction Successful!');
                self.progress = 'addedtoindex';
                console.log('Tx hash=', result);
                // set vote status to TxHash received 
                self.transactionHash = result;
              }
            });
        });
    });

    },

    object2array: function(input){
      var newarray = [];
      var p = input;
      for (var key in p) {
        if (p.hasOwnProperty(key)) {
          p[key]._key = key;
          newarray.push(p[key]);
        }
      };
      return newarray;
    },

   

    _sizeview: function(){
      switch(this.sizeview) {
        case 'phone':
            this.customStyle['--topbar-height'] = '100px';
            this.updateStyles();
            break;
        case 'desktop':
            this.customStyle['--topbar-height'] = '100px';
            this.updateStyles();
            break;
        case 'xlarge':
            this.customStyle['--topbar-height'] = '100px';
            this.updateStyles();
            break;
        default:
        console.log("!!! ** Niks");
      }
    },
    _is: function(a, b) {
      if (b === undefined) {
        b = true;
      }     
      return a === b;
    }    ,



      processMsg: function(e){
        console.log('incoming whisper msg: ', e.detail);

        var input = JSON.parse(e.detail.input)

        switch (input.command){
          case "senduserrequest":
            console.log('create AES key and send it to other party', input.data);

            var crypt = new JSEncrypt({
              default_key_size: 512
            });
            crypt.setPublicKey(input.data.pubkey);

            var aeskey = generateKey(50);
            this.validations[input.from] = {
              easkey: aeskey,
              pubkey:input.data.pubkey
            };

            var encryptedkey = crypt.encrypt(aeskey);

            this.$.whisper.whisperpost(input.from, JSON.stringify({
              command: 'sendaeskey',
              from: this.$.whisper.topic,
              data: encryptedkey
            }));

            break;
          case "senduserdata" :

          var easKey = this.validations[input.from].easkey;
//debugger;
          var decryptedAvatar = CryptoJS.AES.decrypt(input.data,easKey).toString(CryptoJS.enc.Utf8);

          console.log('AESKEY=--',easKey,'--');
          console.log('ENCDATA=',input.data);
          console.log('DATA=',decryptedAvatar);

          var validation = {
            avatardata: decryptedAvatar,
            channel: input.from
          }

          this.validations.push(validation);



            //console.log('show data + validate',input.data,decryptedAvatar);
            break;

          default:
            //console.log('discard message',e.detail);
            break;

        }        


        // define the characters to pick from
       
        // create a key for symmetric encryption
        // pass in the desired length of your key
        function generateKey(keyLength){
           var chars = "0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz*&-%/!?*+=()";
          var randomstring = '';
          
          for (var i=0; i < keyLength; i++) {
            var rnum = Math.floor(Math.random() * chars.length);
            randomstring += chars.substring(rnum,rnum+1);
          }
          return randomstring;
        };

      },

      fixaddress: function(address) {
        function strStartsWith(str, prefix) {
          return str.indexOf(prefix) === 0;
        }

        if (!strStartsWith(address, '0x')) {
          return ('0x' + address);
        }
        return address;
      }


  });
</script>
